#!/bin/bash
set -e

echo "=== åŸŸåç»‘å®š VPS IP+ç«¯å£å¹¶å¼€å¯ HTTPS ==="

read -rp "è¯·è¾“å…¥ä½ çš„åŸŸåï¼ˆä¾‹å¦‚ example.comï¼‰: " DOMAIN
read -rp "è¯·è¾“å…¥æœåŠ¡è¿è¡Œçš„æœ¬åœ°ç«¯å£ï¼ˆä¾‹å¦‚ 8181ï¼‰: " LOCAL_PORT

NGINX_SITE_CONF="/etc/nginx/sites-enabled/${DOMAIN}"

# ç”Ÿæˆæ ‡å‡† nginx é…ç½®
cat > "$NGINX_SITE_CONF" <<EOF
server {
    listen 80;
    server_name $DOMAIN;

    location / {
        proxy_pass http://127.0.0.1:$LOCAL_PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

echo "âœ… é…ç½®å·²å†™å…¥ $NGINX_SITE_CONF"

# æµ‹è¯• nginx é…ç½®
if nginx -t; then
    echo "ðŸ”¹ nginx é…ç½®æµ‹è¯•é€šè¿‡ï¼Œæ­£åœ¨é‡è½½ nginx..."
    systemctl reload nginx
else
    echo "âŒ nginx é…ç½®æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶"
fi

# èŽ·å– HTTPS è¯ä¹¦
echo "ðŸ”¹ æ­£åœ¨ä¸º $DOMAIN èŽ·å– HTTPS è¯ä¹¦..."
certbot --nginx -d "$DOMAIN" --non-interactive --agree-tos -m your-email@example.com || {
    echo "âš ï¸ è¯ä¹¦èŽ·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥åŸŸåè§£æžå’Œ nginx é…ç½®"
}

echo "=============================="
echo "åŸŸå $DOMAIN å·²ç»‘å®šåˆ° http://127.0.0.1:$LOCAL_PORT"
echo "HTTPS å·²å¼€å¯ï¼Œå¯é€šè¿‡ https://$DOMAIN è®¿é—®"
echo "è¯·ç¡®ä¿ DNS å·²è§£æžåˆ° VPS å…¬ç½‘ IP"
echo "=============================="

# ç­‰å¾…ç”¨æˆ·ç¡®è®¤ï¼Œä¸è‡ªåŠ¨é€€å‡º
read -rp "æŒ‰å›žè½¦è¿”å›žä¸Šä¸€çº§èœå•..." dummy
