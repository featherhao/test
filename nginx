#!/bin/bash
set -e

domain_menu() {
    while true; do
        clear
        echo "=============================="
        echo "ðŸ“„ åŸŸåç»‘å®šç®¡ç†"
        echo "=============================="

        # æ˜¾ç¤ºå·²ç»‘å®šåŸŸå
        NGINX_DIR="/etc/nginx/sites-enabled"
        COUNT=0
        for f in "$NGINX_DIR"/*; do
            [[ -f "$f" ]] || continue
            DOMAIN_NAME=$(basename "$f")
            echo "  - $DOMAIN_NAME"
            ((COUNT++))
        done

        if [[ $COUNT -eq 0 ]]; then
            echo "  æš‚æ— ç»‘å®šåŸŸå"
        fi
        echo "=============================="

        echo "1) æ·»åŠ æ–°åŸŸå"
        echo "0) è¿”å›žä¸Šä¸€çº§èœå•"
        read -rp "è¯·è¾“å…¥é€‰é¡¹: " choice

        case $choice in
            1)
                # ================== èŽ·å– VPS å…¬ç½‘ IPv6 ==================
                VPS_IP=$(curl -6 -fsSL https://api64.ipify.org || echo "::1")
                echo "ðŸŒ VPS å…¬ç½‘ IPv6: $VPS_IP"

                # ================== æ£€æŸ¥å¹¶å®‰è£…ä¾èµ– ==================
                install_deps() {
                    if ! command -v nginx &>/dev/null; then
                        echo "ðŸ“¦ æ­£åœ¨å®‰è£… nginx..."
                        apt update -y && apt install -y nginx
                        systemctl enable nginx --now
                    fi

                    if ! command -v certbot &>/dev/null; then
                        echo "ðŸ“¦ æ­£åœ¨å®‰è£… certbot..."
                        apt install -y certbot python3-certbot-nginx
                    fi
                }
                install_deps

                # ================== ç”¨æˆ·è¾“å…¥ ==================
                read -rp "è¯·è¾“å…¥ä½ çš„åŸŸåï¼ˆä¾‹å¦‚ example.comï¼‰: " DOMAIN
                while [[ -z "$DOMAIN" ]]; do
                    read -rp "åŸŸåä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥: " DOMAIN
                done

                read -rp "è¯·è¾“å…¥æœåŠ¡è¿è¡Œçš„æœ¬åœ°ç«¯å£ï¼ˆä¾‹å¦‚ 8181ï¼‰: " PORT
                while [[ ! "$PORT" =~ ^[0-9]+$ ]]; do
                    read -rp "ç«¯å£æ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥: " PORT
                done

                # è‡ªåŠ¨ç”Ÿæˆéšæœºé‚®ç®±
                RANDOM_EMAIL="user$((RANDOM%100000))@random.com"
                read -rp "è¯·è¾“å…¥ä½ çš„é‚®ç®±ï¼ˆç”¨äºŽ HTTPS è¯ä¹¦ï¼Œç•™ç©ºåˆ™éšæœºç”Ÿæˆï¼‰: " EMAIL
                if [[ -z "$EMAIL" ]]; then
                    EMAIL="$RANDOM_EMAIL"
                    echo "âš¡ ä½¿ç”¨éšæœºé‚®ç®±: $EMAIL"
                fi

                # ================== å†™å…¥ nginx é…ç½® ==================
                NGINX_CONF="/etc/nginx/sites-enabled/$DOMAIN"
                mkdir -p "$(dirname "$NGINX_CONF")"

                cat > "$NGINX_CONF" <<EOF
server {
    listen 80;
    listen [::]:80;
    server_name $DOMAIN;

    location / {
        proxy_pass http://[::1]:$PORT;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

                echo "âœ… é…ç½®å·²å†™å…¥ $NGINX_CONF"

                # ================== æµ‹è¯•å¹¶é‡è½½ nginx ==================
                if nginx -t; then
                    systemctl reload nginx
                    echo "ðŸ”¹ nginx é…ç½®æµ‹è¯•é€šè¿‡ï¼Œå·²é‡è½½ nginx"
                else
                    echo "âš ï¸ nginx é…ç½®æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥"
                fi

                # ================== èŽ·å– HTTPS è¯ä¹¦ ==================
                if certbot --nginx -d "$DOMAIN" --email "$EMAIL" --agree-tos --non-interactive; then
                    echo "âœ… HTTPS è¯ä¹¦èŽ·å–æˆåŠŸ"
                else
                    echo "âš ï¸ è¯ä¹¦èŽ·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥åŸŸåè§£æžå’Œ nginx é…ç½®"
                fi

                echo "=============================="
                echo "åŸŸå $DOMAIN å·²ç»‘å®šåˆ° http://[$VPS_IP]:$PORT"
                echo "HTTPS å·²å¼€å¯ï¼Œå¯é€šè¿‡ https://$DOMAIN è®¿é—®ï¼ˆå¦‚æžœè¯ä¹¦èŽ·å–æˆåŠŸï¼‰"
                echo "è¯·ç¡®ä¿ DNS AAAA å·²è§£æžåˆ° VPS å…¬ç½‘ IPv6: $VPS_IP"
                echo "=============================="

                read -rp "æŒ‰å›žè½¦è¿”å›žåŸŸåç®¡ç†èœå•..." dummy
                ;;
            0)
                break  # è¿”å›žä¸Šä¸€çº§èœå•
                ;;
            *)
                echo "âš ï¸ é€‰é¡¹æ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥"
                sleep 1
                ;;
        esac
    done
}

# è°ƒç”¨äºŒçº§èœå•
domain_menu
