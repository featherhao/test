#!/bin/bash
set -e

echo "=== åŸŸåç»‘å®š VPS IP + ç«¯å£å¹¶å¼€å¯ HTTPS ==="

# è¯»å–ç”¨æˆ·è¾“å…¥
read -rp "è¯·è¾“å…¥ä½ çš„åŸŸåï¼ˆä¾‹å¦‚ example.comï¼‰: " DOMAIN
read -rp "è¯·è¾“å…¥æœåŠ¡è¿è¡Œçš„æœ¬åœ°ç«¯å£ï¼ˆä¾‹å¦‚ 8181ï¼‰: " PORT
read -rp "è¯·è¾“å…¥ä½ çš„é‚®ç®±ï¼ˆç”¨äºŽ HTTPS è¯ä¹¦ï¼‰: " EMAIL

# èŽ·å– VPS å…¬ç½‘ IP
VPS_IP=$(curl -s https://api.ip.sb/ip)
if [[ -z "$VPS_IP" ]]; then
    echo "âŒ æ— æ³•èŽ·å– VPS å…¬ç½‘ IPï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"
    exit 1
fi

# åˆ›å»º nginx é…ç½®ç›®å½•
mkdir -p /etc/nginx/sites-enabled

# å†™å…¥ nginx é…ç½®æ–‡ä»¶
NGINX_CONF="/etc/nginx/sites-enabled/$DOMAIN"
cat > "$NGINX_CONF" <<EOF
server {
    listen 80;
    server_name $DOMAIN;

    location / {
        proxy_pass http://$VPS_IP:$PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

echo "âœ… é…ç½®å·²å†™å…¥ $NGINX_CONF"

# æµ‹è¯• nginx é…ç½®å¹¶é‡è½½
if nginx -t; then
    echo "ðŸ”¹ nginx é…ç½®æµ‹è¯•é€šè¿‡ï¼Œæ­£åœ¨é‡è½½ nginx..."
    systemctl reload nginx
else
    echo "âŒ nginx é…ç½®æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ $NGINX_CONF"
fi

# èŽ·å– HTTPS è¯ä¹¦
echo "ðŸ”¹ æ­£åœ¨ä¸º $DOMAIN èŽ·å– HTTPS è¯ä¹¦..."
if certbot --nginx -d "$DOMAIN" --email "$EMAIL" --agree-tos --non-interactive; then
    echo "âœ… HTTPS å·²æˆåŠŸå¯ç”¨ï¼Œå¯é€šè¿‡ https://$DOMAIN è®¿é—®"
else
    echo "âš ï¸ è¯ä¹¦èŽ·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥åŸŸåè§£æžå’Œ nginx é…ç½®"
fi

echo "=============================="
echo "åŸŸå $DOMAIN å·²ç»‘å®šåˆ° http://$VPS_IP:$PORT"
echo "è¯·ç¡®ä¿ DNS å·²è§£æžåˆ° VPS å…¬ç½‘ IP"
echo "=============================="
read -rp "æŒ‰å›žè½¦è¿”å›žä¸Šä¸€çº§èœå•..." dummy
